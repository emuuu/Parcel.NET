@namespace Parcel.NET.Docs.Playground.DHL
@inject PlaygroundSessionService Session
@inject CarrierClientFactory ClientFactory

<h1 class="h3 mb-3">DHL Sandbox Playground</h1>
<p class="text-muted mb-4">Test DHL Parcel DE Shipping &amp; Tracking API operations against the sandbox environment.</p>

<CredentialsPanel Title="DHL Credentials" IsComplete="@CredentialsComplete">
    <DhlCredentialsForm Credentials="Session.DhlCredentials" OnChanged="StateHasChanged" />
</CredentialsPanel>

<OperationSelector Operations="_operations" Selected="@_selectedOp"
                   OnSelected="op => { _selectedOp = op; _result = null; }" />

@switch (_selectedOp)
{
    case "CreateShipment":
        <DhlCreateShipmentForm CredentialsReady="CredentialsComplete" OnResult="HandleResult" />
        break;
    case "ValidateShipment":
        <DhlValidateShipmentForm CredentialsReady="CredentialsComplete" OnResult="HandleResult" />
        break;
    case "CancelShipment":
        <DhlCancelShipmentForm CredentialsReady="CredentialsComplete" OnResult="HandleResult" />
        break;
    case "CreateManifest":
        <DhlCreateManifestForm CredentialsReady="CredentialsComplete" OnResult="HandleResult" />
        break;
    case "Track":
        <DhlTrackForm CredentialsReady="CredentialsComplete" OnResult="HandleResult" />
        break;
}

<ResponseViewer Result="_result" />

@if (_result?.IsSuccess == true && _labels is { Count: > 0 })
{
    <LabelViewer Labels="_labels" FileName="dhl-label" />
}

@code {
    private readonly List<string> _operations =
        ["CreateShipment", "ValidateShipment", "CancelShipment", "CreateManifest", "Track"];

    private string _selectedOp = "CreateShipment";
    private PlaygroundResult? _result;
    private List<Parcel.NET.Abstractions.Models.ShipmentLabel>? _labels;

    private bool CredentialsComplete => _selectedOp == "Track"
        ? Session.DhlCredentials.IsTrackingComplete
        : Session.DhlCredentials.IsShippingComplete;

    private void HandleResult(PlaygroundResult result)
    {
        _result = result;
        _labels = null;

        if (result.IsSuccess && result.Data is Parcel.NET.Abstractions.Models.ShipmentResponse sr)
        {
            _labels = sr.Labels;
        }
    }
}
