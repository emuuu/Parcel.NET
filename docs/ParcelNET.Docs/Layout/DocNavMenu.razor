@namespace ParcelNET.Docs.Layout
@inject DocContentService ContentService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@implements IDisposable

<div class="nav-menu p-3">
    <input type="text" class="form-control form-control-sm mb-3" placeholder="Filter..."
           @bind="_filter" @bind:event="oninput" />

    @foreach (var navSection in ContentService.GetNavSections())
    {
        var visibleItems = navSection.Items
            .Where(i => Matches(i.Title))
            .ToList();

        if (visibleItems.Count == 0) continue;

        <h6 class="nav-section-title text-uppercase text-muted fw-bold small mt-3 mb-1 px-2">@navSection.Category</h6>
        <ul class="nav flex-column">
            @foreach (var item in visibleItems)
            {
                var href = $"docs/{item.Slug}";
                <li class="nav-item">
                    <NavLink class="nav-link py-1 px-2" href="@href" Match="NavLinkMatch.All"
                             @onclick="() => OnNavigate.InvokeAsync()">
                        @item.Title
                    </NavLink>
                </li>
            }
        </ul>
    }
</div>

@code {
    [Parameter] public EventCallback OnNavigate { get; set; }

    private string _filter = "";
    private bool _needsScroll;

    private bool Matches(string title) =>
        string.IsNullOrWhiteSpace(_filter) ||
        title.Contains(_filter.Trim(), StringComparison.OrdinalIgnoreCase);

    protected override async Task OnInitializedAsync()
    {
        Navigation.LocationChanged += OnLocationChanged;
        await ContentService.InitializeAsync();
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        _needsScroll = true;
        StateHasChanged();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_needsScroll)
        {
            _needsScroll = false;
            await JS.InvokeVoidAsync("ParcelNetDocs.scrollNavToActive");
        }
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }
}
