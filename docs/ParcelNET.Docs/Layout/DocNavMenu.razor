@namespace ParcelNET.Docs.Layout
@inject DocContentService ContentService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@implements IDisposable

<div class="nav-menu p-3">
    <input type="text" class="form-control form-control-sm mb-3" placeholder="Filter..."
           @bind="_filter" @bind:event="oninput" />

    <h6 class="nav-section-title text-uppercase text-muted fw-bold small mt-3 mb-1 px-2">Playground</h6>
    <ul class="nav flex-column">
        <li class="nav-item">
            <NavLink class="nav-link py-1 px-2" href="playground/dhl" Match="NavLinkMatch.All"
                     @onclick="() => OnNavigate.InvokeAsync()">
                DHL Sandbox
            </NavLink>
        </li>
        <li class="nav-item">
            <NavLink class="nav-link py-1 px-2" href="playground/goexpress" Match="NavLinkMatch.All"
                     @onclick="() => OnNavigate.InvokeAsync()">
                GO! Express Sandbox
            </NavLink>
        </li>
    </ul>

    @foreach (var navSection in ContentService.GetNavSections())
    {
        var visibleItems = navSection.Items
            .Where(Matches)
            .ToList();

        if (visibleItems.Count == 0) continue;

        <h6 class="nav-section-title text-uppercase text-muted fw-bold small mt-3 mb-1 px-2">@navSection.Category</h6>
        <ul class="nav flex-column">
            @foreach (var subGroup in visibleItems.GroupBy(i => i.Subcategory))
            {
                @if (subGroup.Key is not null)
                {
                    <li class="nav-item">
                        <span class="nav-link py-1 px-2 fw-semibold small text-body-secondary">@subGroup.Key</span>
                    </li>
                }
                @foreach (var item in subGroup)
                {
                    var href = $"docs/{item.Slug}";
                    var indent = subGroup.Key is not null;
                    var displayTitle = indent && item.Title.StartsWith(subGroup.Key + " ", StringComparison.Ordinal)
                        ? item.Title[(subGroup.Key!.Length + 1)..]
                        : item.Title;
                    <li class="nav-item">
                        <NavLink class="@($"nav-link py-1 {(indent ? "ps-4 pe-2" : "px-2")}")" href="@href" Match="NavLinkMatch.All"
                                 @onclick="() => OnNavigate.InvokeAsync()">
                            @displayTitle
                        </NavLink>
                    </li>
                }
            }
        </ul>
    }
</div>

@code {
    [Parameter] public EventCallback OnNavigate { get; set; }

    private string _filter = "";
    private bool _needsScroll;

    private bool Matches(ContentIndexEntry entry) =>
        string.IsNullOrWhiteSpace(_filter) ||
        entry.Title.Contains(_filter.Trim(), StringComparison.OrdinalIgnoreCase) ||
        (entry.Subcategory?.Contains(_filter.Trim(), StringComparison.OrdinalIgnoreCase) ?? false);

    protected override async Task OnInitializedAsync()
    {
        Navigation.LocationChanged += OnLocationChanged;
        await ContentService.InitializeAsync();
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        _needsScroll = true;
        StateHasChanged();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_needsScroll)
        {
            _needsScroll = false;
            await JS.InvokeVoidAsync("ParcelNetDocs.scrollNavToActive");
        }
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }
}
