@namespace ParcelNET.Docs.Playground.Shared
@inject IJSRuntime JS
@using ParcelNET.Abstractions.Models

@if (Labels is { Count: > 0 })
{
    <div class="card mb-3">
        <div class="card-header d-flex align-items-center justify-content-between py-2">
            <span class="fw-semibold small">Label</span>
            <button class="btn btn-sm btn-outline-primary" @onclick="DownloadLabel">
                Download
            </button>
        </div>
        <div class="card-body p-0">
            @{
                var label = Labels[0];
            }
            @if (label.Format == LabelFormat.Pdf)
            {
                <iframe class="playground-label-iframe"
                        src="@GetPdfDataUrl(label)"></iframe>
            }
            else
            {
                <pre class="playground-response mb-0 p-3"><code>@System.Text.Encoding.UTF8.GetString(label.Content)</code></pre>
            }
        </div>
    </div>
}

@code {
    [Parameter] public List<ShipmentLabel>? Labels { get; set; }
    [Parameter] public string FileName { get; set; } = "label";

    private static string GetPdfDataUrl(ShipmentLabel label) =>
        $"data:application/pdf;base64,{Convert.ToBase64String(label.Content)}";

    private async Task DownloadLabel()
    {
        if (Labels is not { Count: > 0 }) return;
        var label = Labels[0];

        if (label.Format == LabelFormat.Pdf)
        {
            var dataUrl = GetPdfDataUrl(label);
            await JS.InvokeVoidAsync("ParcelNetDocs.downloadBase64File", dataUrl, $"{FileName}.pdf");
        }
        else
        {
            var text = System.Text.Encoding.UTF8.GetString(label.Content);
            var dataUrl = $"data:text/plain;base64,{Convert.ToBase64String(label.Content)}";
            await JS.InvokeVoidAsync("ParcelNetDocs.downloadBase64File", dataUrl, $"{FileName}.zpl");
        }
    }
}
